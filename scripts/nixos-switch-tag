#!/usr/bin/env bash
set -euo pipefail

usage() {
  cat <<'EOF'
Usage:
  nixos-switch-tag --host <flake-host> [--repo <path>] [--tag-prefix <p>] [--force-tag] [--skip-flake-lock]

Example:
  ./scripts/nixos-switch-tag --host nixos-thinkpad
  ./scripts/nixos-switch-tag --host nixos-thinkpad --tag-prefix nixos

What it does:
  1) Refuses to run if git tree is dirty (including untracked files)
  2) Builds the system closure for the host, then switches to it
  3) Tags the current commit with the new generation number (per host)

Tag format:
  <tag-prefix>/<host>/gen-<N>
EOF
}

PROFILE=/nix/var/nix/profiles/system

get_generation() {
  local target
  target="$(readlink "$PROFILE")"
  if [[ "$target" =~ ^system-([0-9]+)-link$ ]]; then
    echo "${BASH_REMATCH[1]}"
    return 0
  fi
  echo "Error: unexpected system profile link: $PROFILE -> '$target'" >&2
  return 1
}

SKIP_FLAKE_LOCK=0
FLAKE_DIR="nixos" # Relative to the repo root
FLAKE_LOCK="${FLAKE_DIR}/flake.lock"
REPO="."
HOST=""
TAG_PREFIX="nixos"
FORCE_TAG=0

while [[ $# -gt 0 ]]; do
  case "$1" in
    --repo) REPO="$2"; shift 2;;
    --host) HOST="$2"; shift 2;;
    --tag-prefix) TAG_PREFIX="$2"; shift 2;;
    --force-tag) FORCE_TAG=1; shift;;
    --skip-flake-lock) SKIP_FLAKE_LOCK=1; shift;;
    -h|--help) usage; exit 0;;
    *) echo "Unknown arg: $1" >&2; usage; exit 2;;
  esac
done

if [[ -z "$HOST" ]]; then
  echo "Error: --host is required" >&2
  usage
  exit 2
fi

cd "$REPO"

# ---- 1) Ensure clean git tree ----
if ! git rev-parse --is-inside-work-tree >/dev/null 2>&1; then
  echo "Error: not inside a git repo: $REPO" >&2
  exit 1
fi

if ! git diff --quiet; then
  echo "Error: you have unstaged changes. Commit or stash first." >&2
  exit 1
fi

if ! git diff --cached --quiet; then
  echo "Error: you have staged but uncommitted changes. Commit first." >&2
  exit 1
fi

if [[ -n "$(git ls-files --others --exclude-standard)" ]]; then
  echo "Error: you have untracked files. Add/commit them or clean them first." >&2
  exit 1
fi

# ---- 2) Check for flake.lock updates ----

nix flake lock "./${FLAKE_DIR}" --commit-lock-file

# Check for updates
tmp="$(mktemp -d)"
trap 'rm -rf "$tmp"' EXIT
cp -a "./${FLAKE_DIR}/." "$tmp"
(
  cd "$tmp"
  nix flake update --flake . >/dev/null
)

if ! diff -q "./${FLAKE_DIR}/flake.lock" "$tmp/flake.lock" >/dev/null; then
  echo "Warning: Updates are available for existing flake inputs"
  echo "         Run: nix flake update --flake \"./${FLAKE_DIR}\""
fi

# ---- 3) Build then switch ----

COMMIT="$(git rev-parse HEAD)"
echo "Repo clean at commit: $COMMIT"

GEN_BEFORE="$(get_generation)"
if [[ -z "$GEN_BEFORE" ]]; then
  echo "Error: failed to parse previous generation from $PROFILE -> $TARGET" >&2
  exit 1
fi

if ! [[ "$GEN_BEFORE" =~ ^[0-9]+$ ]]; then
  echo "Error: parsed previous generation is not numeric: '$GEN_NUM'" >&2
  exit 1
fi

echo "Building system for host: $HOST"
nix build --no-link --no-update-lock-file "./${FLAKE_DIR}#nixosConfigurations.${HOST}.config.system.build.toplevel"

echo "Switching to new configuration..."
sudo nixos-rebuild switch --no-update-lock-file --flake "./${FLAKE_DIR}#${HOST}"

# ---- 4) Get current generation number ----
GEN_NUM="$(get_generation)"
if [[ -z "$GEN_NUM" ]]; then
  echo "Error: failed to parse generation from $PROFILE -> $TARGET" >&2
  exit 1
fi

if ! [[ "$GEN_NUM" =~ ^[0-9]+$ ]]; then
  echo "Error: parsed generation is not numeric: '$GEN_NUM'" >&2
  exit 1
fi

if [[ "$GEN_NUM" == "$GEN_BEFORE" ]]; then
  echo "No new system generation produced (still $GEN_NUM). Skipping tag."
  exit 0
fi

# ---- 5) Create the tag ----
TAG="${TAG_PREFIX}/${HOST}/gen-${GEN_NUM}"

# Ensure we're still on the same commit we built from
COMMIT_AFTER="$(git rev-parse HEAD)"
if [[ "$COMMIT_AFTER" != "$COMMIT" ]]; then
  echo "Error: HEAD changed during run ($COMMIT -> $COMMIT_AFTER). Refusing to tag." >&2
  exit 1
fi

# Create tag
if git rev-parse -q --verify "refs/tags/${TAG}" >/dev/null; then
  if [[ "$FORCE_TAG" -eq 1 ]]; then
    echo "Tag already exists; replacing because --force-tag was provided: $TAG"
    git tag -d "$TAG" >/dev/null
  else
    echo "Error: tag already exists: $TAG (use --force-tag to replace)" >&2
    exit 1
  fi
fi

echo "Tagging commit $COMMIT with $TAG"
git tag -a "$TAG" -m "NixOS generation ${GEN_NUM} for host ${HOST}"

echo "Done."
echo "  Commit: $COMMIT"
echo "  Gen:    $GEN_NUM"
echo "  Tag:    $TAG"
echo ""
echo "Next: push the tag with:"
echo "  git push --follow-tags"
